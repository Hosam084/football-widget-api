<script>
    document.addEventListener("DOMContentLoaded", function () {
        const c = document.getElementById("matchesContainer"),
            d = document.querySelector(".date-filter"),
            f = document.getElementById("leagueFilter");

        let g = "today",
            a = []; 

        // 🛠️ دالة قراءة التاريخ بصيغة MM/DD/YYYY HH:MM
        function parseDate(dateStr) {
            const [d, t] = dateStr.split(" ");
            const [month, day, year] = d.split("/");
            return new Date(`${year}-${month}-${day}T${t}:00`);
        }

        function p(m) {
            const l = [...new Set(m.map(i => i.league).filter(l => l && l.trim() !== ''))];
            f.innerHTML = '<option value="all">كل الدوريات</option>';
            l.forEach(l => {
                const opt = document.createElement("option");
                opt.value = l;
                opt.textContent = l;
                f.appendChild(opt)
            })
        }

        d.addEventListener("click", function (e) {
            if (e.target.tagName === "BUTTON") {
                document.querySelectorAll(".date-filter button").forEach(b => b.classList.remove("active"));
                e.target.classList.add("active");
                g = e.target.dataset.day;
                h()
            }
        });
        f.addEventListener("change", () => h());

        function h() {
            if (a.length === 0) {
                c.innerHTML = '<div class="loading">جاري تحميل المباريات...</div>';
                return
            }
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let filtered = a.filter(m => {
                const md = parseDate(m.date);
                if (isNaN(md.getTime())) return !1;

                md.setHours(0, 0, 0, 0);
                const diff = Math.round((md - today) / (1e3 * 60 * 60 * 24));
                if (g === "today") return diff === 0;
                if (g === "yesterday") return diff === -1;
                if (g === "tomorrow") return diff === 1;
                return !1
            });

            if (f.value !== "all") filtered = filtered.filter(m => m.league === f.value);
            if (filtered.length === 0) {
                c.innerHTML = '<div class="loading">لا توجد مباريات</div>';
                return
            }
            const sorted = filtered.sort((a, b) => parseDate(a.date) - parseDate(b.date));
            L(sorted)
        }

        function L(m) {
            c.innerHTML = "";
            m.forEach(m => {
                const card = document.createElement("div");
                card.id = `match-${m.matchId}`;
                card.className = "match-card";

                const md = parseDate(m.date);
                const timeString = md.toLocaleTimeString("ar-EG", {
                    hour: "2-digit",
                    minute: "2-digit"
                });

                let statusClass, statusText, centerContent;
                const status = (m.status || "").trim().toLowerCase();

                if (status.includes("مباشر")) {
                    statusClass = "status-live";
                    statusText = "مباشر";
                    centerContent = `<div class="score" id="score-${m.matchId}">${m.scoreHome||"0"} - ${m.scoreAway||"0"}</div>`;
                } else if (status.includes("انتهت") || status.includes("finished") || status.includes("ft")) {
                    statusClass = "status-finished";
                    statusText = "انتهت";
                    centerContent = `<div class="score" id="score-${m.matchId}">${m.scoreHome||"0"} - ${m.scoreAway||"0"}</div>`;
                } else {
                    statusClass = "status-upcoming";
                    statusText = "لم تبدأ";
                    centerContent = `<div class="center-time">${timeString}</div>`;
                }

                card.innerHTML = `
                    <div class="match-header">
                        <span class="league-name">${m.league}</span>
                    </div>
                    <div class="team home">
                        ${m.homeLogo?`<img src="${m.homeLogo}" class="team-logo">`:``}
                        <span class="team-name">${m.homeTeam}</span>
                    </div>
                    <div class="match-center">
                        <div class="status ${statusClass}" id="status-${m.matchId}">${statusText}</div>
                        ${centerContent}
                    </div>
                    <div class="team away">
                        ${m.awayLogo?`<img src="${m.awayLogo}" class="team-logo">`:``}
                        <span class="team-name">${m.awayTeam}</span>
                    </div>`;
                c.appendChild(card)
            })
        }

        function updateDOMWithMatchData(matches) {
            matches.forEach(match => {
                const scoreElement = document.getElementById(`score-${match.matchId}`);
                const statusElement = document.getElementById(`status-${match.matchId}`);

                if (scoreElement) {
                    scoreElement.textContent = `${match.scoreHome} - ${match.scoreAway}`;
                }

                if (statusElement) {
                    const status = (match.status || "").trim().toLowerCase();
                    let statusClass, statusText;

                    if(status.includes("مباشر")) {
                        statusClass = "status-live";
                        statusText = "مباشر";
                    } else if (status.includes("انتهت") || status.includes("finished") || status.includes("ft")) {
                        statusClass = "status-finished";
                        statusText = "انتهت";
                    } else {
                        statusClass = "status-upcoming";
                        statusText = "لم تبدأ";
                    }

                    statusElement.textContent = statusText;
                    statusElement.className = `status ${statusClass}`;
                }
            });
        }

        function fetchAndUpdateMatches() {
            fetch('/matches.json?t=' + new Date().getTime()) 
                .then(response => {
                    if (!response.ok) throw new Error("فشل في جلب البيانات");
                    return response.json();
                })
                .then(data => {
                    if (a.length === 0) {
                        a = data; 
                        p(a);    
                        h();     
                    } else {
                        updateDOMWithMatchData(data);
                        a = data; 
                    }
                })
                .catch(error => {
                    console.error("Error during live update:", error);
                    if (a.length === 0) {
                        c.innerHTML = '<div class="error">فشل في تحميل البيانات. يرجى المحاولة لاحقاً.</div>';
                    }
                });
        }

        fetchAndUpdateMatches();
        setInterval(fetchAndUpdateMatches, 30000);
    });
                </script>
